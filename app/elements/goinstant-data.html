<!--
  Go Instant data element.

  Requires the go-connect element.

  Ex: <go-data key="/test"></go-data>

  <go-connect account="ACCOUNT_NUMBER" app="APP_NAME" room="ROOM_NAME"></go-connect>

  <script>
    var goConnect = document.querySelector('go-connect'),
        goData = document.querySelector('go-data');

    goConnect.go().then(function(connection) {
      goData.findAll(connection, function(data) {
        console.log(data.value);
      });
    });
  </script>
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="goinstant-connect.html">

<polymer-element name="go-data" extends="go-connect" attributes="key">
  <template></template>

  <script>
    (function() {
      /*
       * Start Private functions
       */
      function _getKey(con, keyName) {
        return con.rooms[0].key(keyName);
      }

      /*
       * Return public polymer object
       */
      return Polymer('go-data', {
        key: null, // Placeholder for key name

        /*
         * Get all data from specified key
         * Requires connection promise result
         * returns object
         */
        findAll: function(con, callback) {
          if(!con) {
            throw 'ERR: a connection is required!';
          }

          var key = _getKey(con, this.key);

          key.get().then(function(res) {
            if(callback) {
              callback(res);
            }

            return res;
          });
        },

        /*
         * Get queried data from specified
         * Requires connection promise result
         * returns array
         */
        find: function(con, params, callback) {
          var key = _getKey(con, this.key);

          var query = key.query(params);

          query.execute(function(err, results) {
            if (err) {
              throw err;
            }

            if(callback) {
              callback(results);
            }

            return results;
          });
        },

        /*
         * Add new data to specified key
         * Requires connection promise results, and value to be saved
         */
        add: function(con, val, callback) {
          var key = _getKey(con, this.key);

          key.add(val, function(err, newValue) {
            if(err) {
              throw err;
            }

            if(callback) {
              callback(newValue);
            }

            return newValue;
          });
        },

        /*
         * Delete specified data from key
         */
        remove: function(con, id) {
          var parentKey = _getKey(con, this.key);

          parentKey.key(id).remove();
        }
      });
    })();
  </script>
</polymer-element>