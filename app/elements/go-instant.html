<!--
  Go Instant data element.

  Requires the go-connect element.

  Ex: <go-data key="/test"></go-data>

  <go-connect account="ACCOUNT_NUMBER" app="APP_NAME" room="ROOM_NAME"></go-connect>

  <script>
    var goConnect = document.querySelector('go-connect'),
        goData = document.querySelector('go-data');

    goConnect.go().then(function(connection) {
      goData.findAll(connection, function(data) {
        console.log(data.value);
      });
    });
  </script>
-->

<polymer-element name="go-instant" attributes="account app room key">
  <template></template>

  <script>
    (function() {
      /*
       * Start Private functions
       */
      function _getConnection(account, app, room) {
        var url = 'https://goinstant.net/' + account + '/' + app;

        var opts = {};

        /*
         * If room is defined connect to it
         * otherwise connect to lobby
         */
        if(room) {
          opts.room = room;
        }

        return goinstant.connect(url, opts);
      }

      function _getKey(con, keyName) {
        return con.rooms[0].key(keyName);
      }

      /*
       * Return public polymer object
       */
      return Polymer('go-instant', {
        account: null,
        app: null,
        room: null,
        key: null, // Placeholder for key name

        /*
         * Get all data from specified key
         * Requires connection promise result
         * returns object
         */
        findAll: function(callback) {
          var that = this;

          _getConnection(this.account, this.app, this.room).then(function(connection) {
            if(!connection) {
              throw 'ERR: a connection is required!';
            }

            var key = _getKey(connection, that.key);

            key.get().then(function(res) {
              if(callback) {
                callback(res);
              }

              return res;
            });
          });
        },

        /*
         * Get queried data from specified
         * Requires connection promise result
         * returns array
         */
        find: function(params, callback) {
          var that = this;

          _getConnection(this.account, this.app, this.room).then(function(connection) {
            var key = _getKey(connection, that.key);

            var query = key.query(params);

            query.execute(function (err, res) {
              if (err) {
                throw err;
              }

              if (callback) {
                callback(res);
              }

              return res;
            });
          });
        },

        /*
         * Add new data to specified key
         * Requires connection promise results, and value to be saved
         */
        add: function(val, callback) {
          var that = this;

          _getConnection(this.account, this.app, this.room).then(function(connection) {
            var key = _getKey(connection, that.key);

            key.add(val, function (err, newValue) {
              if (err) {
                throw err;
              }

              if (callback) {
                callback(newValue);
              }

              return newValue;
            });
          });
        },

        /*
         * Delete specified data from key
         */
        remove: function(id, callback) {
          var that = this;

          _getConnection(this.account, this.app, this.room).then(function(connection) {
            var parentKey = _getKey(connection, that.key);

            parentKey.key(id).remove();

            if(callback) {
              callback();
            }
          });
        }
      });
    })();
  </script>
</polymer-element>