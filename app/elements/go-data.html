<!--
  Go Instant data element.

  Uses connection to go get queried data from specified key.
  Requires the go-connect element.

  Ex: <go-data key="/test" query="{'author': 'Stan Lee'}"></go-data>

  <script>
    document.querySelector('go-data').addEventListener('gotData', function(res) {
      console.log(res.detail.data);
    });
  </script>

  Events Emitted: 'gotKey', 'gotData'
-->

<polymer-element name="go-data" extends="go-connect" attributes="key query">
  <template></template>

  <script>
    (function() {
      /*
       * Return desired Key
       */
      function _getKey(con, keyName) {
        return con.rooms[0].key(keyName);
      }

      /*
       * Return queried data from key
       */
      function _find(key, params, callback) {
        var queryString;

        if(params) {
          queryString = JSON.parse( params.replace(/\'/g, "\"") );
        } else {
         queryString = {};
        }

        var query = key.query( queryString );

        query.execute(function(err, res) {
          if (err) {
            throw err;
          }

          if(callback) {
            callback(res);
          }

          return res;
        });
      }

      /*
       * Public polymer methods
       */
      Polymer('go-data', {
        /*
         * Defaults for key and query
         */
        key: null,
        query: null,

        /*
         * Containers for connection and roomKey
         * Store here for later use without going through entire
         * connection process again
         */
        connection: null,
        roomKey: null,

        /*
         * mark if element is initialized
         */
        initialized: false,

        /*
         * If key attribute is changed find data
         */
        keyChanged: function() {
          if(this.initialized) {
            this.roomKey = _getKey(this.connection, this.key);

            this.findHelper();
          }
        },

        /*
         * If query attribute is changed find data
         */
        queryChanged: function() {
          if(this.initialized) {
            this.findHelper();
          }
        },

        /*
         * Set _find callback so that it fires the 'gotData' event
         */
        findHelper: function() {
          _find(this.roomKey, this.query, function(res) {

            this.fire('gotData', {data: res});

          }.bind(this));
        },

        attached: function() {
          this.addEventListener('gotKey', function() {
            this.initialized = true; //after data is found set initialized to true

            this.findHelper();
          });

          document.addEventListener('connected', function(con) {

            this.connection = con.detail.connection;

            this.roomKey = _getKey(this.connection, this.key);

            this.fire('gotKey', {key: this.roomKey});

          }.bind(this));
        }
      });
    })();
  </script>
</polymer-element>