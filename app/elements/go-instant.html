<!--
  Go Instant data element.

  Requires the go-connect element.

  Ex: <go-data key="/test"></go-data>

  <go-connect account="ACCOUNT_NUMBER" app="APP_NAME" room="ROOM_NAME"></go-connect>

  <script>
    var goConnect = document.querySelector('go-connect'),
        goData = document.querySelector('go-data');

    goConnect.go().then(function(connection) {
      goData.findAll(connection, function(data) {
        console.log(data.value);
      });
    });
  </script>
-->

<polymer-element name="go-instant" attributes="account app room key">
  <template></template>

  <script>
    (function() {
      /*
       * Start Private functions
       */
      function _connect(account, app, room) {
        var url = 'https://goinstant.net/' + account + '/' + app;

        var opts = {};

        /*
         * If room is defined connect to it
         * otherwise connect to lobby
         */
        if(room) {
          opts.room = room;
        }

        return goinstant.connect(url, opts);
      }

      function _getKey(con, keyName) {
        return con.rooms[0].key(keyName);
      }

      function _findAll(account, app, room, key) {
        var con = _connect(account, app, room);

        if(!con) {
          throw 'ERR: a connection is required!';
        }

        var roomKey = key, data;

        con.then(function(connection) {
          alert('connected!');

          var key = _getKey(connection, roomKey);

          key.get().then(function(res) {
            alert('data retrieved');

            console.log(res.value);

            return res.value;
          });
        });
      }

      /*
       * Return public polymer object
       */
      return Polymer('go-instant', {
        account: null,
        app: null,
        room: null,
        key: null,

        ready: function() {
          _findAll(this.account, this.app, this.room, this.key);
        }
      });
    })();
  </script>
</polymer-element>