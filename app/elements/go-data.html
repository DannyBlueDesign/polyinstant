<polymer-element name="go-data" attributes="key query">
  <template></template>

  <script>
    (function() {
      /*
       * Return desired Key
       */
      function _getKey(con, keyName) {
        return con.rooms[0].key(keyName);
      }

      /*
       * Return queried data from key
       */
      function _find(key, params, callback) {
        var queryString;

        if(params) {
          queryString = JSON.parse( params.replace(/\'/g, "\"") );
        } else {
         queryString = {};
        }

        var query = key.query( queryString );

        query.execute(function(err, res) {
          if (err) {
            throw err;
          }

          if(callback) {
            callback(res);
          }

          return res;
        });
      }

      /*
       * Public polymer methods
       */
      Polymer('go-data', {
        /*
         * Defaults for key and query
         */
        key: null,
        query: null,

        /*
         * Containers for connection and roomKey
         * Store here for later use without going through entire
         * connection process again
         */
        connection: null,
        roomKey: null,

        ready: function() {
          this.addEventListener('gotKey', function() {

            _find(this.roomKey, this.query, function(res) {

              this.fire('gotData', {data: res});

            }.bind(this));

          });

          document.addEventListener('connected', function(con) {
            
            this.connection = con.detail.connection;

            this.roomKey = _getKey(this.connection, this.key);

            this.fire('gotKey', {key: this.roomKey});

          }.bind(this));
        }
      });
    })();
  </script>
</polymer-element>